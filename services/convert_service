import os
import subprocess
import img2pdf
import fitz  # PyMuPDF
from pdf2docx import Converter
from pptx import Presentation
from helpers import unique_path

def images_to_pdf(files):
    """Converts multiple JPG/PNG images into one PDF."""
    output_path = unique_path("BuiltTheory_Images.pdf")
    image_bytes = [f.read() for f in files]
    with open(output_path, "wb") as f:
        f.write(img2pdf.convert(image_bytes))
    return output_path

def pdf_to_jpg(file):
    """Converts PDF pages into high-quality JPG images."""
    doc = fitz.open(stream=file.read(), filetype="pdf")
    output_path = unique_path("BuiltTheory_Preview.jpg")
    page = doc.load_page(0)
    pix = page.get_pixmap()
    pix.save(output_path)
    return output_path

def pdf_to_word(file):
    """Converts PDF documents back into editable Word (.docx) files."""
    pdf_path = unique_path("temp_convert.pdf")
    docx_path = unique_path("BuiltTheory_Editable.docx")
    with open(pdf_path, "wb") as f:
        f.write(file.read())
    cv = Converter(pdf_path)
    cv.convert(docx_path)
    cv.close()
    return docx_path

def generate_pptx(topic, details):
    """Generates a professional engineering PPT structure."""
    prs = Presentation()
    slide = prs.slides.add_slide(prs.slide_layouts[0])
    slide.shapes.title.text = topic
    slide.placeholders[1].text = details
    output_path = unique_path("BuiltTheory_Academic_Slides.pptx")
    prs.save(output_path)
    return output_path

def office_to_pdf(file, extension):
    """
    Uses LibreOffice to convert Word, Excel, or PPT to PDF.
    This is required for your PRO tools to work.
    """
    input_path = unique_path(f"temp_input.{extension}")
    with open(input_path, "wb") as f:
        f.write(file.read())
    
    output_dir = os.path.dirname(input_path)
    # This runs the 'libreoffice' command you set up in render.yaml
    subprocess.run([
        'libreoffice', '--headless', '--convert-to', 'pdf', 
        '--outdir', output_dir, input_path
    ], check=True)
    
    return input_path.rsplit('.', 1)[0] + ".pdf"
