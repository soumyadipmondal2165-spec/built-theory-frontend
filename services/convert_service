import img2pdf
import os
import fitz # PyMuPDF
from pdf2docx import Converter
from pptx import Presentation
from services.helpers import unique_path

def images_to_pdf(files):
    """Converts images (JPG/PNG) into a single PDF."""
    output_path = unique_path("BuiltTheory_Images.pdf")
    with open(output_path, "wb") as f:
        f.write(img2pdf.convert([f.read() for f in files]))
    return output_path

def pdf_to_jpg(file):
    """Converts a PDF page into a JPG image."""
    doc = fitz.open(stream=file.read(), filetype="pdf")
    output_path = unique_path("BuiltTheory_Preview.jpg")
    page = doc.load_page(0)
    pix = page.get_pixmap()
    pix.save(output_path)
    return output_path

def pdf_to_word(file):
    """Converts PDF into an editable Word document."""
    pdf_path = unique_path("temp.pdf")
    docx_path = unique_path("BuiltTheory_Converted.docx")
    with open(pdf_path, "wb") as f:
        f.write(file.read())
    cv = Converter(pdf_path)
    cv.convert(docx_path)
    cv.close()
    return docx_path

def generate_pptx(topic, details):
    """Generates a professional engineering PPT structure."""
    prs = Presentation()
    slide = prs.slides.add_slide(prs.slide_layouts[0])
    slide.shapes.title.text = topic
    slide.placeholders[1].text = details
    output_path = unique_path("BuiltTheory_Presentation.pptx")
    prs.save(output_path)
    return output_path
